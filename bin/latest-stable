#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

source "${plugin_dir}/lib/utils.bash"

curl_opts=(-fsSL)

if [ -n "${GITHUB_API_TOKEN:-}" ]; then
	curl_opts=("${curl_opts[@]}" -H "Authorization: token $GITHUB_API_TOKEN")
fi

version=$(curl "${curl_opts[@]}" "https://api.github.com/gists/512b78b430fad751d2466b72da4a4893" |
	python3 -c "import sys, json;
try:
    commits = json.load(sys.stdin)['history'];
    if commits:
        print(commits[0]['version'][:7])
except:
    sys.exit(1)" 2>/dev/null)

if [ -z "$version" ]; then
	version=$(list_all_versions | sort_versions | tail -n1 | xargs echo)
fi

printf "%s\n" "$version"
